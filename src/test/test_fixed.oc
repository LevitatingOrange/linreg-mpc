#include <obliv.oh>
#include "fixed.h"
#include "fixed.oh"
#include "test/test_fixed.h"


void test_fixed(void *v) {
	protocolIO *args = v;
	
	// check for equal length inputs
	bool equal;
	revealOblivBool(&equal, 
		feedOblivInt(args->len, 1) == 
		feedOblivInt(args->len, 2), 0);

	if(!equal) {
		args->len = -1;
		return;
	} 
	
	// compute the square root of the dot product of a and b
	obig c, x, y, t;
	obig_init(&c, 4);
	obig_init(&x, 4);
	obig_init(&y, 4);
	obig_init(&t, 4);
	for(int i = 0; i < args->len; i++) {
		// assuming sizeof(int) == sizeof(fixed32_t)
		obig_import_onative_signed(&x, feedOblivInt(args->inputs[i], 1));
		obig_import_onative_signed(&y, feedOblivInt(args->inputs[i], 2));
		ofixed_mul(&t, x, y, args->p);
		ofixed_add(&c, c, t);
	}
	ofixed_sqrt(&c, c, args->p);
	
	obliv uint32_t out = obig_export_onative_signed(c);
	revealOblivInt(&(args->result), out, 0);
	args->gates = yaoGateCount();

	obig_free(&c);
	obig_free(&x);
	obig_free(&y);
	obig_free(&t);
}
